<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="style.css" rel="stylesheet">
    <title>Skyblock Invest Tool</title>
</head>
<body>
    <div id="content">
        <h1>Skyblock Invest Tool</h1>
        <div id="form">
        <div id="toggle-bar" onclick="toggleForm()">Input Your Record</div>
        <!-- <div>
            <button id="toggle-form-button" onclick="toggleForm()">Toggle Form</button>
        </div> -->
        
        <form id="record-form">
            <label for="item-name">Item Name:</label>
            <input type="text" id="item-name" name="item-name"><br><br>
            <label for="item-tag">Item Tag (Metadata):</label>
            <input type="text" id="item-tag" name="item-tag"><br><br>
            <label for="item-quantity">Item Quantity:</label>
            <input type="number" id="item-quantity" name="item-quantity"><br><br>
            <label for="item-price">Item Cost (average):</label>
            <input type="number" id="item-price" name="item-price"><br><br>
            <label for="action">Action:</label>
            <select id="action" name="action">
                <option value="buy">Buy</option>
                <option value="sell">Sell</option>
            </select><br><br>
            <button id="submit-button" type="submit">Submit</button>
            <div id="record-message" class="warning center"></div>
        </form>
        </div>

        <div id="item-list-container">
            <div id="item-list-header">
                <h2 id="list-title">Item List</h2>
                <button id="update-button">Update Price</button>
            </div>
            <div id="timer">Fire Sale Countdown: <span id="countdown"></span></div>
        </div>
        <table id="item-list">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Average Cost</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody id="item-list-body">
                <!-- Table content will go here -->
            </tbody>
        </table>
    </div>
    <script>
        function toggleForm() {
            var form = document.getElementById("record-form");
            form.style.display = form.style.display === "none" ? "block" : "none";
            document.getElementById('toggle-bar').classList.toggle('active');
        }
    </script>
    
    <script>
    
    </script>
    <script src="scripts/record.js"></script>
    <script>
        const updateButton = document.getElementById('update-button');
        const itemListBody = document.getElementById('item-list-body');
        let itemList = [];

        // click -> call backend -> get data from json -> call 3rd party api
        updateButton.addEventListener('click', () => {
            fetch('/update')
                .then(response => response.json())
                .then(data => {
                    // Update the table with the new data
                    for (const key in data) {
                        console.log(itemList);
                        // if itemList contains key
                        if (itemList.includes(key)) {
                            // get the index of key in itemList
                            const index = itemList.indexOf(key);
                            // based on the index, udpate the corresponding row in table
                            const row = itemListBody.rows[index];
                            const priceCell = row.cells[1];
                            const costCell = row.cells[2];
                            const quantityCell = row.cells[3];
                            priceCell.textContent = data[key]['price'];
                            costCell.textContent = data[key]['avgCost'];
                            quantityCell.textContent = data[key]['quantity'];
                        } else {
                            // add to tracked item list
                            itemList.push(key);
                            // add a new row in the table
                            const row = itemListBody.insertRow();
                            const nameCell = row.insertCell(0);
                            const priceCell = row.insertCell(1);
                            const costCell = row.insertCell(2);
                            const quantityCell = row.insertCell(3);
                            nameCell.textContent = key;
                            priceCell.textContent = data[key]['price'];
                            costCell.textContent = data[key]['avgCost'];
                            quantityCell.textContent = data[key]['quantity'];
                        }
                        
                        
                    }   
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
        });

        // Submit event for the input form
        $("#record-form").on("submit", (e) => {
            // Do not submit the form
            e.preventDefault();

            // Get the input fields
            const itemName = $("#item-name").val().trim();
            const itemTag = $("#item-tag").val().trim();
            const itemQuantity = $("#item-quantity").val().trim();
            const itemPrice = $("#item-price").val().trim();
            const action = $("#action").val().trim();

            // Send a register request
            Record.record(itemName, itemTag, itemQuantity, itemPrice, action,
                () => {
                    $("#record-form").get(0).reset();
                    $("#record-message").text("Record submitted.");
                },
                (error) => { $("#record-message").text(error); }
            );
        });
        // init update
        $(function() {
            $("#update-button").click();
            var form = document.getElementById("record-form");
            form.style.display = "none";

            const fireSaleData = fetch('/firesale')
                .then(response => response.json())
                .then(data => {
                    if (data['status'] === "error") {
                        $("#countdown").text(data['error']);
                    } else {
                        console.log(data['start']);
                        const eventDate = new Date(data['data']['start']).getTime();
                        console.log(eventDate);
                        const timer = setInterval(function() {
                            const now = new Date().getTime();
                            const distance = eventDate - now;
                            if (distance < 0) {
                                clearInterval(timer);
                                document.getElementById("countdown").innerHTML = "Event has started!";
                                return;
                            }
                            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                            document.getElementById("countdown").innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
                        }, 1000);
                        $("#countdown").text("Firesale data updated successfully.");
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });

        });
    </script>
    

</body>
</html>